<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Inferencia Roboflow en Vivo</title>
  <style>
    video, canvas {
      width: 300px;
      border: 1px solid #ccc;
      margin: 10px;
    }
    #overlay {
      position: absolute;
      top: 0;
      left: 0;
      z-index: 10;
      pointer-events: none;
    }
    #videoWrapper {
      position: relative;
      display: inline-block;
    }
  </style>
</head>
<body>
  <h2>Detección en vivo con Roboflow</h2>
  <div id="videoWrapper">
    <video id="video" autoplay muted playsinline></video>
    <canvas id="overlay"></canvas>
  </div>
  <pre id="output"></pre>

  <script>
    const video = document.getElementById('video');
    const overlay = document.getElementById('overlay');
    const output = document.getElementById('output');

    // Acceder a la cámara
    navigator.mediaDevices.getUserMedia({ video: true })
      .then(stream => {
        video.srcObject = stream;
        video.onloadedmetadata = () => {
          overlay.width = video.videoWidth;
          overlay.height = video.videoHeight;
          startDetection();
        };
      })
      .catch(err => alert('Error al acceder a la cámara: ' + err));

    const apiKey = 'Qj0G0aIWu17HtSpDZdMk';
    const modelEndpoint = https://detect.roboflow.com/cf700/4?api_key=${apiKey};

    async function startDetection() {
      const ctx = overlay.getContext('2d');
      const offscreen = document.createElement('canvas');
      const interval = 1000; // Tiempo entre detecciones (ms)

      offscreen.width = overlay.width;
      offscreen.height = overlay.height;
      const offCtx = offscreen.getContext('2d');

      setInterval(async () => {
        offCtx.drawImage(video, 0, 0, offscreen.width, offscreen.height);
        const blob = await new Promise(resolve => offscreen.toBlob(resolve, 'image/jpeg'));

        const formData = new FormData();
        formData.append('file', blob, 'frame.jpg');

        try {
          const res = await fetch(modelEndpoint, {
            method: 'POST',
            body: formData
          });

          const data = await res.json();
          output.textContent = JSON.stringify(data, null, 2);

          ctx.clearRect(0, 0, overlay.width, overlay.height);
          ctx.strokeStyle = 'lime';
          ctx.lineWidth = 2;
          ctx.font = '14px sans-serif';
          ctx.fillStyle = 'lime';

          (data?.predictions || []).forEach(pred => {
            const { x, y, width, height, class: label, confidence } = pred;
            const left = x - width / 2;
            const top = y - height / 2;

            ctx.strokeRect(left, top, width, height);
            ctx.fillText(${label} (${(confidence * 100).toFixed(1)}%), left, top - 5);
          });

        } catch (err) {
          console.error('Error al hacer inferencia:', err);
        }

      }, interval);
    }
  </script>
</body>
</html>
