<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Visualización de componentes de motor CF700</title>
  <script type="module" src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"></script>
  <style>
    video, canvas {
      width: 300px;
      border: 1px solid #ccc;
      margin: 10px;
    }
    #overlay {
      position: absolute;
      top: 0;
      left: 0;
      z-index: 10;
      pointer-events: none;
    }
    #videoWrapper {
      position: relative;
      display: inline-block;
    }
    #modelsContainer {
      display: flex;
      flex-wrap: wrap;
      gap: 16px;
      margin-top: 20px;
    }
    model-viewer {
      width: 300px;
      height: 300px;
      border: 2px solid #444;
    }
    .model-card {
      border: 1px solid #aaa;
      padding: 10px;
      width: 320px;
      background-color: #f9f9f9;
      border-radius: 8px;
    }
    .model-card h3 {
      margin: 5px 0;
    }
    .model-card p {
      margin: 2px 0;
    }
    #output {
      display: none;
    }
  </style>
</head>
<body>
  <h2>Modelos detectados</h2>
  <div id="videoWrapper">
    <video id="video" autoplay muted playsinline></video>
    <canvas id="overlay"></canvas>
  </div>

  <div id="modelsContainer"></div>
  <pre id="output"></pre>

  <script>
    const video = document.getElementById('video');
    const overlay = document.getElementById('overlay');
    const modelsContainer = document.getElementById('modelsContainer');

    const modelMap = {
      "Accessory Drive Section": "ADS.glb",
      "After Fan": "aft_ensamble.glb",
      "Combustion Section": "combustion_section_ensamble_cut.glb",
      "Compressor": "compressor_ensamble_cut.glb",
      "Drive Shaft": null,
      "Front Frame": "Front_frame_ensamble.glb",
      "Fuel injector": "fuel_injector.glb",
      "Turbine": "Turbine.glb"
    };

    const techSpecs = {
      "Accessory Drive Section": {
        description: "Consiste en el conjunto de accesorios, caja de engranajes de transferencia y caja de accesorios. ",
        function: "Su función es transmitir la energía del eje del motor a los accesorios del motor."
      },
      "After Fan": {
        description: "Consta de una carcasa, cuerpo central y puntales.",
        function: "Se encarga de confinar y dirigir el flujo de los gases de escapes de la turbina y brinda soporte del tubo de escape del motor."
      },
      "Combustion Section": {
        description: "Consiste en la carcasa de combustión externa, carcasa de combustión interna, trazador de líneas de combustión, balero número 3 y su apoyo, el escudo del eje y protector de calor de combustión.",
        function: "Aquí es donde se mezcla el aire con el combustible y se enciende."
      },
      "Compressor": {
        description: "Está comuesto por el macro frontal del compresor, cubierta del estator del compresor, rotor del compresor y estructura central.",
        function: "Comprime el aire haciendo que sea más fácil de encender."
      },
      "Front Frame": {
        description: "Compuesto por una cubierta interior y exterior que se unen por quince puntales huecos.",
        function: "Su función principal es dirigir la entrada de flujo de aire hacia el compresor y dar soporte a los quince alabes de entrada variable."
      },
      "Turbine": {
        description: "Consiste en la carcasa de turbina, envolventes, tobera del rotor y estator.",
        function: "Su principal función es extraer energía de los gases de escape producto de la combustión necesaria para impulsar el compresor y proporcionar el empuje para mover la aeronave."
      },
      "Fuel injector":{
        description: "Doce inyectores de combustible están atornillados a doce puntos equidistantes alrededor el eje central.",
        function: "Proporciona un patrón de pulverizaión de combustible para diferentes rangos de operación del motor.",
      }
    };

    const shownModels = new Set();

    navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })
      .then(stream => {
        video.srcObject = stream;
        video.onloadedmetadata = () => {
          overlay.width = video.videoWidth;
          overlay.height = video.videoHeight;
          startDetection();
        };
      })
      .catch(err => alert('Error al acceder a la cámara: ' + err));

    const apiKey = 'Qj0G0aIWu17HtSpDZdMk';
    const modelEndpoint = `https://detect.roboflow.com/cf700/4?api_key=${apiKey}`;

    async function startDetection() {
      const ctx = overlay.getContext('2d');
      const offscreen = document.createElement('canvas');
      const interval = 1500;
      offscreen.width = overlay.width;
      offscreen.height = overlay.height;
      const offCtx = offscreen.getContext('2d');

      setInterval(async () => {
        offCtx.drawImage(video, 0, 0, offscreen.width, offscreen.height);
        const blob = await new Promise(resolve => offscreen.toBlob(resolve, 'image/jpeg'));

        const formData = new FormData();
        formData.append('file', blob, 'frame.jpg');

        try {
          const res = await fetch(modelEndpoint, {
            method: 'POST',
            body: formData
          });

          const data = await res.json();
          ctx.clearRect(0, 0, overlay.width, overlay.height);
          ctx.strokeStyle = 'lime';
          ctx.lineWidth = 2;
          ctx.font = '14px sans-serif';
          ctx.fillStyle = 'lime';

          (data?.predictions || []).forEach(pred => {
            const { x, y, width, height, class: label } = pred;
            const left = x - width / 2;
            const top = y - height / 2;
            ctx.strokeRect(left, top, width, height);

            const modelFile = modelMap[label];
            if (modelFile && !shownModels.has(modelFile)) {
              const container = document.createElement('div');
              container.className = 'model-card';

              const modelViewer = document.createElement('model-viewer');
              modelViewer.setAttribute('src', modelFile);
              modelViewer.setAttribute('alt', label);
              modelViewer.setAttribute('auto-rotate', '');
              modelViewer.setAttribute('camera-controls', '');
              modelViewer.setAttribute('ar', '');
              modelViewer.setAttribute('shadow-intensity', '1');

              const specs = techSpecs[label];
              if (specs) {
                const info = document.createElement('div');
                info.innerHTML = `
                  <h3>${label}</h3>
                  <p><strong>Descripción:</strong> ${specs.description}</p>
                  <p><strong>Función:</strong> ${specs.function}</p>
                `;
                container.appendChild(info);
              }

              container.appendChild(modelViewer);
              modelsContainer.appendChild(container);
              shownModels.add(modelFile);
            }
          });
        } catch (err) {
          console.error('Error al hacer inferencia:', err);
        }
      }, interval);
    }
  </script>
</body>
</html>
