<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Detección en Vivo con Roboflow y Múltiples Modelos</title>
  <script type="module" src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"></script>
  <style>
    video, canvas {
      width: 300px;
      border: 1px solid #ccc;
      margin: 10px;
    }
    #overlay {
      position: absolute;
      top: 0;
      left: 0;
      z-index: 10;
      pointer-events: none;
    }
    #videoWrapper {
      position: relative;
      display: inline-block;
    }
    #modelsContainer {
      display: flex;
      flex-wrap: wrap;
      gap: 16px;
      margin-top: 20px;
    }
    model-viewer {
      width: 300px;
      height: 300px;
      border: 2px solid #444;
    }
    #output {
      display: none; /* Ocultar salida JSON */
    }
  </style>
</head>
<body>
  <h2>Modelos detectados</h2>
  <div id="videoWrapper">
    <video id="video" autoplay muted playsinline></video>
    <canvas id="overlay"></canvas>
  </div>

  <div id="modelsContainer"></div>

  <pre id="output"></pre>

  <script>
    const video = document.getElementById('video');
    const overlay = document.getElementById('overlay');
    const output = document.getElementById('output');
    const modelsContainer = document.getElementById('modelsContainer');

    const modelMap = {
      "Accessory Drive Section": "ADS.glb",
      "After Fan": "aft_ensamble.glb",
      "Combustion Section": "combustion_section_ensamble_cut.gltf",
      "Compressor": "compressor_ensamble_cut.glb",
      "Drive Shaft": null,
      "Front Frame": "Front_frame_ensamble.glb",
      "Fuel injector": null,
      "Turbine": "Turbine.glb"
    };

    const shownModels = new Set(); // Para evitar duplicados

    navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })
      .then(stream => {
        video.srcObject = stream;
        video.onloadedmetadata = () => {
          overlay.width = video.videoWidth;
          overlay.height = video.videoHeight;
          startDetection();
        };
      })
      .catch(err => alert('Error al acceder a la cámara: ' + err));

    const apiKey = 'Qj0G0aIWu17HtSpDZdMk';
    const modelEndpoint = `https://detect.roboflow.com/cf700/4?api_key=${apiKey}`;

    async function startDetection() {
      const ctx = overlay.getContext('2d');
      const offscreen = document.createElement('canvas');
      const interval = 1500;

      offscreen.width = overlay.width;
      offscreen.height = overlay.height;
      const offCtx = offscreen.getContext('2d');

      setInterval(async () => {
        offCtx.drawImage(video, 0, 0, offscreen.width, offscreen.height);
        const blob = await new Promise(resolve => offscreen.toBlob(resolve, 'image/jpeg'));

        const formData = new FormData();
        formData.append('file', blob, 'frame.jpg');

        try {
          const res = await fetch(modelEndpoint, {
            method: 'POST',
            body: formData
          });

          const data = await res.json();
          ctx.clearRect(0, 0, overlay.width, overlay.height);
          ctx.strokeStyle = 'lime';
          ctx.lineWidth = 2;
          ctx.font = '14px sans-serif';
          ctx.fillStyle = 'lime';

          (data?.predictions || []).forEach(pred => {
            const { x, y, width, height, class: label } = pred;
            const left = x - width / 2;
            const top = y - height / 2;

            ctx.strokeRect(left, top, width, height);

            const modelFile = modelMap[label];
            if (modelFile && !shownModels.has(modelFile)) {
              const modelViewer = document.createElement('model-viewer');

              modelViewer.setAttribute('src', modelFile);
              modelViewer.setAttribute('alt', label);
              modelViewer.setAttribute('auto-rotate', '');
              modelViewer.setAttribute('camera-controls', '');
              modelViewer.setAttribute('ar', '');
              modelViewer.setAttribute('shadow-intensity', '1');

              modelViewer.addEventListener('error', e => {
                console.error(`Error al cargar modelo: ${modelFile}`, e);
              });

              modelsContainer.appendChild(modelViewer);
              shownModels.add(modelFile);
            }
          });

        } catch (err) {
          console.error('Error al hacer inferencia:', err);
        }

      }, interval);
    }
  </script>
</body>
</html>
