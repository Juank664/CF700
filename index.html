<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Visualizaci칩n de componentes de motor CF700</title>
  <script type="module" src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"></script>
  <style>
    video, canvas {
      width: 300px;
      border: 1px solid #ccc;
      margin: 10px;
    }
    #overlay {
      position: absolute;
      top: 0;
      left: 0;
      z-index: 10;
      pointer-events: none;
    }
    #videoWrapper {
      position: relative;
      display: inline-block;
    }
    #modelsContainer {
      display: flex;
      flex-wrap: wrap;
      gap: 16px;
      margin-top: 20px;
    }
    model-viewer {
      width: 300px;
      height: 300px;
      border: 2px solid #444;
    }
    .model-card {
      border: 1px solid #aaa;
      padding: 10px;
      width: 320px;
      background-color: #f9f9f9;
      border-radius: 8px;
    }
    .model-card h3 {
      margin: 5px 0;
    }
    .model-card p {
      margin: 2px 0;
    }
    #output {
      display: none;
    }
  </style>
</head>
<body>
  <h2>Modelos detectados</h2>
  <div id="videoWrapper">
    <video id="video" autoplay muted playsinline></video>
    <canvas id="overlay"></canvas>
  </div>

  <div id="modelsContainer"></div>
  <pre id="output"></pre>

  <script>
    const video = document.getElementById('video');
    const overlay = document.getElementById('overlay');
    const modelsContainer = document.getElementById('modelsContainer');

    const modelMap = {
      "Accessory Drive Section": "ADS.glb",
      "After Fan": "aft_ensamble.glb",
      "Combustion Section": "combustion_section_ensamble_cut.glb",
      "Compressor": "compressor_ensamble_cut.glb",
      "Drive Shaft": null,
      "Front Frame": "Front_frame_ensamble.glb",
      "Fuel injector": "fuel_injector.glb",
      "Turbine": "Turbine.glb"
    };

    const techSpecs = {
      "Accessory Drive Section": {
        description: "",
        function: ""
      },
      "After Fan": {
        description: "",
        function: ""
      },
      "Combustion Section": {
        description: "",
        function: ""
      },
      "Compressor": {
        description: "",
        function: ""
      },
      "Front Frame": {
        description: "",
        function: ""
      },
      "Turbine": {
        description: "",
        function: ""
      },
      "Fuel injector":{
        description: "",
        function: "",
      }
    };

    const shownModels = new Set();

    navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })
      .then(stream => {
        video.srcObject = stream;
        video.onloadedmetadata = () => {
          overlay.width = video.videoWidth;
          overlay.height = video.videoHeight;
          startDetection();
        };
      })
      .catch(err => alert('Error al acceder a la c치mara: ' + err));

    const apiKey = 'Qj0G0aIWu17HtSpDZdMk';
    const modelEndpoint = `https://detect.roboflow.com/cf700/4?api_key=${apiKey}`;

    async function startDetection() {
      const ctx = overlay.getContext('2d');
      const offscreen = document.createElement('canvas');
      const interval = 1500;
      offscreen.width = overlay.width;
      offscreen.height = overlay.height;
      const offCtx = offscreen.getContext('2d');

      setInterval(async () => {
        offCtx.drawImage(video, 0, 0, offscreen.width, offscreen.height);
        const blob = await new Promise(resolve => offscreen.toBlob(resolve, 'image/jpeg'));

        const formData = new FormData();
        formData.append('file', blob, 'frame.jpg');

        try {
          const res = await fetch(modelEndpoint, {
            method: 'POST',
            body: formData
          });

          const data = await res.json();
          ctx.clearRect(0, 0, overlay.width, overlay.height);
          ctx.strokeStyle = 'lime';
          ctx.lineWidth = 2;
          ctx.font = '14px sans-serif';
          ctx.fillStyle = 'lime';

          (data?.predictions || []).forEach(pred => {
            const { x, y, width, height, class: label } = pred;
            const left = x - width / 2;
            const top = y - height / 2;
            ctx.strokeRect(left, top, width, height);

            const modelFile = modelMap[label];
            if (modelFile && !shownModels.has(modelFile)) {
              const container = document.createElement('div');
              container.className = 'model-card';

              const modelViewer = document.createElement('model-viewer');
              modelViewer.setAttribute('src', modelFile);
              modelViewer.setAttribute('alt', label);
              modelViewer.setAttribute('auto-rotate', '');
              modelViewer.setAttribute('camera-controls', '');
              modelViewer.setAttribute('ar', '');
              modelViewer.setAttribute('shadow-intensity', '1');

              const specs = techSpecs[label];
              if (specs) {
                const info = document.createElement('div');
                info.innerHTML = `
                  <h3>${label}</h3>
                  <p><strong>Descripci칩n:</strong> ${specs.description}</p>
                  <p><strong>Funci칩n:</strong> ${specs.function}</p>
                `;
                container.appendChild(info);
              }

              container.appendChild(modelViewer);
              modelsContainer.appendChild(container);
              shownModels.add(modelFile);
            }
          });
        } catch (err) {
          console.error('Error al hacer inferencia:', err);
        }
      }, interval);
    }
  </script>
</body>
</html>
